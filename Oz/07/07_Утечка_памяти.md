### **Что произойдёт, когда закончится память на голом сервере?**

Если на голом сервере происходит утечка памяти и вся физическая память исчерпывается, то последствия зависят от состояния системы и конфигурации:

---

### **Сценарии, когда заканчивается память**

1. **Если своп включён:**
   - Своп (swap) — это область на диске, используемая как "резервная память", когда физическая оперативная память заканчивается.
   - Когда утечка памяти заполняет всю физическую память, система начинает использовать своп.
   - **Что произойдёт:**
     - Система станет работать медленнее из-за высокой задержки доступа к диску (по сравнению с оперативной памятью).
     - Если своп полностью заполнится, система активирует **OOM Killer** (Out of Memory Killer).

2. **Если своп выключен:**
   - Когда заканчивается физическая память и своп недоступен, система немедленно запускает **OOM Killer**.
   - OOM Killer завершает процессы с наибольшим приоритетом для освобождения памяти.

---

### **Как работает OOM Killer?**

OOM Killer — это механизм ядра Linux, который активируется, когда системе критически не хватает памяти. Он завершает один или несколько процессов, чтобы освободить ресурсы.

#### **На что опирается OOM Killer?**
1. **Реально используемая память**:
   - Система оценивает **реально используемую физическую память**, а не виртуальную.
   - Учитываются страницы памяти, которые фактически мапятся в физическую оперативную память.

2. **OOM Score**:
   - У каждого процесса есть параметр `oom_score`, который показывает, насколько процесс подвержен завершению при недостатке памяти.
   - OOM Score рассчитывается на основе:
     - Используемой физической памяти.
     - Приоритета процесса (`oom_score_adj`).
     - Веса процесса для системы (например, фоновые задачи менее важны, чем пользовательские приложения).

#### **Как выбрать процесс для завершения?**
OOM Killer завершает процесс с высоким `oom_score`, чтобы освободить наибольшее количество памяти.

#### **Пример проверки OOM Score:**
```bash
cat /proc/<pid>/oom_score
cat /proc/<pid>/status | grep VmRSS
```
- `VmRSS`: показывает реальный объём физической памяти, используемый процессом.
- `oom_score`: вероятность завершения процесса.

---

### **Почему нужна виртуальная память?**

Виртуальная память — это механизм операционной системы, который создаёт абстракцию для программ, предоставляя им видимость "собственного пространства памяти". Она реализуется через механизм страниц (paging).

#### **Основные задачи виртуальной памяти:**

1. **Разделение памяти между процессами**:
   - Каждый процесс имеет своё виртуальное адресное пространство.
   - Процессы изолированы друг от друга: один процесс не может получить доступ к памяти другого.

2. **Управление физической памятью**:
   - Операционная система может перемещать редко используемые страницы памяти на диск (в своп) и загружать их обратно по мере необходимости.
   - Это позволяет эффективно использовать физическую память.

3. **Защита памяти**:
   - Механизм виртуальной памяти позволяет защищать области памяти.
   - Например, запрещать запись в определённый сегмент (Read-Only) или предотвращать выполнение данных как кода.

4. **Упрощение программирования**:
   - Программисты работают с виртуальными адресами, не заботясь о распределении физической памяти.

---

### **Как виртуальная память трансформируется в физическую?**

1. **Разделение адреса на страницы**:
   - Виртуальный адрес делится на **номер страницы** и **смещение внутри страницы**.
   - Например, для страницы размером 4 КБ:
     - Первые 20 бит: номер страницы.
     - Последние 12 бит: смещение внутри страницы.

2. **Таблицы страниц**:
   - Таблицы страниц хранят соответствие между виртуальными страницами и физическими.
   - Если виртуальная страница не отображена на физическую память, происходит **прерывание (page fault)**.

3. **Подкачка в своп**:
   - Если для виртуальной страницы нет физической памяти, она может быть сохранена на диск (своп).

---

### **Пример из жизни: почему нужна виртуальная память**

Представьте, что у вас на ноутбуке открыто 10 приложений:
- Каждое приложение "думает", что у него есть доступ к 16 ГБ оперативной памяти (виртуальная память).
- На самом деле у вас всего 8 ГБ физической памяти.
- Операционная система перемещает редко используемые данные приложений на диск, а часто используемые держит в оперативной памяти.
- Это позволяет всем приложениям работать одновременно, несмотря на ограниченность физической памяти.

---

### **Почему `df` и `du` показывают место, но "нет места"?**

Если место в файловой системе ещё доступно, но система сообщает об ошибке "нет места", это может быть связано с:

1. **Закончились inode'ы**:
   - Каждая запись в файловой системе требует inode.
   - Если inode'ы закончились, вы не сможете создавать новые файлы, даже если место есть.
   - **Решение**:
     - Удалите файлы с большим количеством мелких записей.
     - Проверьте использование inode:
       ```bash
       df -i
       ```

2. **Закончился своп**:
   - При недостатке оперативной памяти система пытается использовать своп.
   - Если своп заполнен, OOM Killer может завершить процессы.
   - **Решение**:
     - Увеличьте размер свопа:
       ```bash
       sudo fallocate -l 2G /swapfile
       sudo mkswap /swapfile
       sudo swapon /swapfile
       ```

3. **Резервирование для root**:
   - Файловая система резервирует место для суперпользователя (обычно 5% от объёма).
   - Если пользователь заполнил все доступное место, запись станет невозможной.
   - **Решение**:
     - Уменьшите резервное место:
       ```bash
       sudo tune2fs -m 1 /dev/sdX
       ```

---

### **Итог**

1. **Когда заканчивается память:**
   - Если своп включён, система будет использовать диск, пока и своп не закончится.
   - Если своп выключен, OOM Killer завершит процессы, используя физическую память.

2. **Зачем нужна виртуальная память:**
   - Для изоляции процессов.
   - Для защиты памяти.
   - Для оптимального использования физической памяти.

3. **"Нет места" при наличии свободного пространства:**
   - Закончились inode'ы, своп, или зарезервированное место для root.
   - Решения: удалить ненужные файлы, увеличить своп, проверить квоты.